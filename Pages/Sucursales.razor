@page "/sucursales"
@using ByteBank.Models
@using ByteBank.Services
@inject SucursalService SucursalService
@inject CatalogoService CatalogoService

<PageTitle>Sucursales</PageTitle>

<h1>Gestión de Sucursales</h1>

<div class="mb-3">
    <button class="btn btn-primary" @onclick="MostrarFormularioCrear">
        <span class="bi bi-plus-circle"></span> Nueva Sucursal
    </button>
</div>

@if (mostrarFormulario)
{
    <div class="card mb-3">
        <div class="card-header">
            <h5>Nueva Sucursal</h5>
        </div>
        <div class="card-body">
            <EditForm Model="@nuevaSucursal" OnValidSubmit="CrearSucursal">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label>Nombre de la Sucursal:</label>
                        <InputText class="form-control" @bind-Value="nuevaSucursal.Nombre" />
                    </div>
                    <div class="col-md-3 mb-3">
                        <label>Ciudad:</label>
                        <InputSelect class="form-select" @bind-Value="nuevaSucursal.IdCiudad">
                            <option value="0">Seleccionar...</option>
                            @if (ciudades != null)
                            {
                                @foreach (var ciudad in ciudades)
                                {
                                    <option value="@ciudad.IdCiudad">@ciudad.Nombre</option>
                                }
                            }
                        </InputSelect>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label>Tipo de Sucursal:</label>
                        <InputSelect class="form-select" @bind-Value="nuevaSucursal.IdTipoSucursal">
                            <option value="0">Seleccionar...</option>
                            @if (tiposSucursal != null)
                            {
                                @foreach (var tipo in tiposSucursal)
                                {
                                    <option value="@tipo.IdTipoSucursal">@tipo.Nombre</option>
                                }
                            }
                        </InputSelect>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label>Dirección:</label>
                        <InputText class="form-control" @bind-Value="nuevaSucursal.Direccion" />
                    </div>
                    <div class="col-md-3 mb-3">
                        <label>Teléfono:</label>
                        <InputText class="form-control" @bind-Value="nuevaSucursal.Telefono" />
                    </div>
                    <div class="col-md-3 mb-3">
                        <label>Horario:</label>
                        <InputText class="form-control" @bind-Value="nuevaSucursal.Horario" placeholder="Ej: Lun-Vie 8:00-17:00" />
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-success">Guardar</button>
                    <button type="button" class="btn btn-secondary" @onclick="CancelarFormulario">Cancelar</button>
                </div>
            </EditForm>
        </div>
    </div>
}

@if (sucursales == null)
{
    <p><em>Cargando sucursales...</em></p>
}
else if (!sucursales.Any())
{
    <div class="alert alert-info">
        <strong>No hay sucursales registradas.</strong>
    </div>
}
else
{
    <div class="mb-3">
        <strong>Total de sucursales:</strong> @sucursales.Count
    </div>

    <div class="row">
        @foreach (var sucursal in sucursales)
        {
            <div class="col-md-6 mb-3">
                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">@sucursal.Nombre</h5>
                    </div>
                    <div class="card-body">
                        <p class="mb-2"><strong>ID:</strong> @sucursal.IdSucursal</p>
                        <p class="mb-2"><strong>Dirección:</strong> @sucursal.Direccion</p>
                        <p class="mb-2"><strong>Teléfono:</strong> @sucursal.Telefono</p>
                        <p class="mb-2"><strong>Horario:</strong> @sucursal.Horario</p>
                        <div class="d-flex gap-2 mt-3">
                            <button class="btn btn-sm btn-danger" @onclick="() => EliminarSucursal(sucursal.IdSucursal)">
                                Eliminar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
}

@if (mensaje != null)
{
    <div class="alert @(esError ? "alert-danger" : "alert-success") alert-dismissible fade show" role="alert">
        @mensaje
        <button type="button" class="btn-close" @onclick="() => mensaje = null"></button>
    </div>
}

@code {
    private List<Sucursal>? sucursales;
    private List<Ciudad>? ciudades;
    private List<TipoSucursal>? tiposSucursal;
    private SucursalCreate nuevaSucursal = new();
    private bool mostrarFormulario = false;
    private string? mensaje;
    private bool esError;

    protected override async Task OnInitializedAsync()
    {
        await CargarDatos();
    }

    private async Task CargarDatos()
    {
        sucursales = await SucursalService.GetSucursalesAsync();
        ciudades = await CatalogoService.GetCiudadesAsync();
        tiposSucursal = await CatalogoService.GetTiposSucursalAsync();
    }

    private void MostrarFormularioCrear()
    {
        mostrarFormulario = true;
        nuevaSucursal = new();
    }

    private void CancelarFormulario()
    {
        mostrarFormulario = false;
        nuevaSucursal = new();
    }

    private async Task CrearSucursal()
    {
        var resultado = await SucursalService.CreateSucursalAsync(nuevaSucursal);
        if (resultado != null)
        {
            mensaje = "Sucursal creada exitosamente";
            esError = false;
            mostrarFormulario = false;
            await CargarDatos();
        }
        else
        {
            mensaje = "Error al crear la sucursal";
            esError = true;
        }
    }

    private async Task EliminarSucursal(int id)
    {
        var exito = await SucursalService.DeleteSucursalAsync(id);
        if (exito)
        {
            mensaje = "Sucursal eliminada exitosamente";
            esError = false;
            await CargarDatos();
        }
        else
        {
            mensaje = "Error al eliminar la sucursal";
            esError = true;
        }
    }
}