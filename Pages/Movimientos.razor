@page "/movimientos"
@inject CuentaService CuentaService
@inject MovimientoService MovimientoService

<PageTitle>Movimientos Bancarios</PageTitle>

<h1>Movimientos Bancarios</h1>

<div class="mb-3">
    <button class="btn btn-success me-2" @onclick="MostrarDeposito">
        <i class="bi bi-arrow-down-circle"></i> Depósito
    </button>
    <button class="btn btn-danger me-2" @onclick="MostrarRetiro">
        <i class="bi bi-arrow-up-circle"></i> Retiro
    </button>
    <button class="btn btn-primary" @onclick="MostrarTransferencia">
        <i class="bi bi-arrow-left-right"></i> Transferencia
    </button>
</div>

@if (mensaje != null)
{
    <div class="alert @(esError ? "alert-danger" : "alert-success") alert-dismissible fade show" role="alert">
        @mensaje
        <button type="button" class="btn-close" @onclick="() => mensaje = null"></button>
    </div>
}

<h2 class="mt-4">Lista de Movimientos Realizados</h2>
<table class="table table-striped">
    <thead>
        <tr>
            <th>ID</th>
            <th>Cuenta</th>
            <th>Sucursal</th>
            <th>Fecha</th>
            <th>Valor</th>
            <th>Tipo</th>
            <th>Descripción</th>
        </tr>
    </thead>
    <tbody>
        @if (movimientos == null)
        {
            <tr>
                <td colspan="7">Cargando movimientos...</td>
            </tr>
        }
        else if (!movimientos.Any())
        {
            <tr>
                <td colspan="7">No hay movimientos registrados.</td>
            </tr>
        }
        else
        {
            @foreach (var mov in movimientos)
            {
                <tr>
                    <td>@mov.IdMovimiento</td>
                    <td>@mov.IdCuenta</td>
                    <td>@mov.IdSucursal</td>
                    <td>@mov.Fecha.ToString("yyyy-MM-dd")</td>
                    <td>@mov.Valor.ToString("F2")</td>
                    <td>@mov.IdTipoMovimiento</td>
                    <td>@mov.Descripcion</td>
                </tr>
            }
        }
    </tbody>
</table>

<!-- Modal Depósito -->
@if (mostrarDeposito)
{
    <div class="modal fade show" style="display: block; background-color: rgba(0,0,0,0.5);" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Realizar Depósito</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CerrarModales"></button>
                </div>
                <div class="modal-body">
                    <EditForm Model="@deposito" OnValidSubmit="RealizarDeposito">
                        <div class="mb-3">
                            <label>Cuenta:</label>
                            <InputNumber class="form-control" @bind-Value="deposito.IdCuenta" />
                        </div>
                        <div class="mb-3">
                            <label>Sucursal:</label>
                            <InputNumber class="form-control" @bind-Value="deposito.IdSucursal" />
                        </div>
                        <div class="mb-3">
                            <label>Valor:</label>
                            <InputNumber class="form-control" @bind-Value="deposito.Valor" />
                        </div>
                        <div class="mb-3">
                            <label>Descripción:</label>
                            <InputText class="form-control" @bind-Value="deposito.Descripcion" />
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" @onclick="CerrarModales">Cancelar</button>
                            <button type="submit" class="btn btn-success">Realizar Depósito</button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}

<!-- Modal Retiro -->
@if (mostrarRetiro)
{
    <div class="modal fade show" style="display: block; background-color: rgba(0,0,0,0.5);" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Realizar Retiro</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CerrarModales"></button>
                </div>
                <div class="modal-body">
                    <EditForm Model="@retiro" OnValidSubmit="RealizarRetiro">
                        <div class="mb-3">
                            <label>Cuenta:</label>
                            <InputNumber class="form-control" @bind-Value="retiro.IdCuenta" />
                        </div>
                        <div class="mb-3">
                            <label>Sucursal:</label>
                            <InputNumber class="form-control" @bind-Value="retiro.IdSucursal" />
                        </div>
                        <div class="mb-3">
                            <label>Valor:</label>
                            <InputNumber class="form-control" @bind-Value="retiro.Valor" />
                        </div>
                        <div class="mb-3">
                            <label>Descripción:</label>
                            <InputText class="form-control" @bind-Value="retiro.Descripcion" />
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" @onclick="CerrarModales">Cancelar</button>
                            <button type="submit" class="btn btn-danger">Realizar Retiro</button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}

<!-- Modal Transferencia -->
@if (mostrarTransferencia)
{
    <div class="modal fade show" style="display: block; background-color: rgba(0,0,0,0.5);" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Realizar Transferencia</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CerrarModales"></button>
                </div>
                <div class="modal-body">
                    <EditForm Model="@transferencia" OnValidSubmit="RealizarTransferencia">
                        <div class="mb-3">
                            <label>Cuenta Origen:</label>
                            <InputNumber class="form-control" @bind-Value="transferencia.IdCuentaOrigen" />
                        </div>
                        <div class="mb-3">
                            <label>Cuenta Destino:</label>
                            <InputNumber class="form-control" @bind-Value="transferencia.IdCuentaDestino" />
                        </div>
                        <div class="mb-3">
                            <label>Sucursal:</label>
                            <InputNumber class="form-control" @bind-Value="transferencia.IdSucursal" />
                        </div>
                        <div class="mb-3">
                            <label>Valor:</label>
                            <InputNumber class="form-control" @bind-Value="transferencia.Valor" />
                        </div>
                        <div class="mb-3">
                            <label>Descripción:</label>
                            <InputText class="form-control" @bind-Value="transferencia.Descripcion" />
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" @onclick="CerrarModales">Cancelar</button>
                            <button type="submit" class="btn btn-primary">Realizar Transferencia</button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private DepositoCreate deposito = new();
    private RetiroCreate retiro = new();
    private TransferenciaCreate transferencia = new();
    private string? mensaje;
    private bool esError;

    private bool mostrarDeposito = false;
    private bool mostrarRetiro = false;
    private bool mostrarTransferencia = false;

    private List<Movimiento>? movimientos;

    protected override async Task OnInitializedAsync()
    {
        await CargarMovimientos();
    }

    private async Task CargarMovimientos()
    {
        try
        {
            movimientos = await MovimientoService.GetMovimientosAsync();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error detallado: {ex}");
        }
    }

    private void MostrarDeposito()
    {
        CerrarModales();
        deposito = new();
        mostrarDeposito = true;
        mensaje = null;
    }

    private void MostrarRetiro()
    {
        CerrarModales();
        retiro = new();
        mostrarRetiro = true;
        mensaje = null;
    }

    private void MostrarTransferencia()
    {
        CerrarModales();
        transferencia = new();
        mostrarTransferencia = true;
        mensaje = null;
    }

    private void CerrarModales()
    {
        mostrarDeposito = false;
        mostrarRetiro = false;
        mostrarTransferencia = false;
    }

    private async Task RealizarDeposito()
    {
        try
        {
            var resultado = await MovimientoService.RealizarDepositoAsync(deposito);
            if (resultado != null)
            {
                mensaje = $"Depósito realizado exitosamente. Movimiento ID: {resultado.IdMovimiento}";
                esError = false;
                CerrarModales();
                await CargarMovimientos();
            }
            else
            {
                mensaje = "Error al realizar el depósito";
                esError = true;
            }
        }
        catch (Exception ex)
        {
            mensaje = $"Error: {ex.Message}";
            esError = true;
        }
    }

    private async Task RealizarRetiro()
    {
        try
        {
            var resultado = await MovimientoService.RealizarRetiroAsync(retiro);
            if (resultado != null)
            {
                mensaje = $"Retiro realizado exitosamente. Movimiento ID: {resultado.IdMovimiento}";
                esError = false;
                CerrarModales();
                await CargarMovimientos();
            }
            else
            {
                mensaje = "Error al realizar el retiro";
                esError = true;
            }
        }
        catch (Exception ex)
        {
            mensaje = $"Error: {ex.Message}";
            esError = true;
        }
    }

    private async Task RealizarTransferencia()
    {
        try
        {
            var resultado = await MovimientoService.RealizarTransferenciaAsync(transferencia);
            if (resultado != null)
            {
                mensaje = "Transferencia realizada exitosamente";
                esError = false;
                CerrarModales();
                await CargarMovimientos();
            }
            else
            {
                mensaje = "Error al realizar la transferencia";
                esError = true;
            }
        }
        catch (Exception ex)
        {
            mensaje = $"Error: {ex.Message}";
            esError = true;
        }
    }
}