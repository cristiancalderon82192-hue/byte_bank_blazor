@page "/ciudades"
@using ByteBank.Models
@using ByteBank.Services
@inject CatalogoService CatalogoService
@inject CuentahabienteService CuentahabienteService

<PageTitle>Ciudades</PageTitle>

<h1>Gestión de Ciudades</h1>
<p class="text-muted">Administración de ciudades disponibles en el sistema</p>

<div class="mb-3">
    <button class="btn btn-primary" @onclick="MostrarFormularioCrear">
        <span class="bi bi-plus-circle"></span> Nueva Ciudad
    </button>
</div>
@if (mostrarFormulario || editarFormulario || mostrarConfirmEliminar)
{
    <div class="card mb-3">
        <div class="card-header @(mostrarFormulario ? "bg-primary text-white" : editarFormulario ? "bg-warning text-dark" : "bg-danger text-white")">
            <h5 class="mb-0">@(mostrarFormulario ? "Nueva Ciudad" : editarFormulario ? "Editar Ciudad" : "Confirmar eliminación")</h5>
        </div>
        <div class="card-body">
            @if (mostrarFormulario)
            {
                <EditForm Model="@nuevaCiudad" OnValidSubmit="CrearCiudad">
                    <div class="mb-3">
                        <label>Nombre de la Ciudad:</label>
                        <InputText class="form-control" @bind-Value="nuevaCiudad.Nombre" placeholder="Ej: Bogotá" />
                    </div>
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-success">Guardar</button>
                        <button type="button" class="btn btn-secondary" @onclick="CancelarFormulario">Cancelar</button>
                    </div>
                </EditForm>
            }
            else if (editarFormulario && ciudadEnEdicion != null)
            {
                <EditForm Model="@ciudadEnEdicion" OnValidSubmit="GuardarEdicion">
                    <div class="mb-3">
                        <label>Nombre:</label>
                        <InputText class="form-control" @bind-Value="ciudadEnEdicion.Nombre" />
                    </div>
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">Guardar</button>
                        <button type="button" class="btn btn-secondary" @onclick="CancelarEdicion">Cancelar</button>
                    </div>
                </EditForm>
            }
            else if (mostrarConfirmEliminar && ciudadAEliminarId.HasValue)
            {
                <p>¿Desea eliminar la ciudad <strong>@ciudadAEliminarNombre</strong>?</p>
                @if (!string.IsNullOrEmpty(cuentahabienteAsociadoMensaje))
                {
                    <div class="alert alert-warning">
                        <strong>Atención:</strong> Esta ciudad está asociada al/los cuentahabiente(s):
                        <div class="mt-2"><em>@cuentahabienteAsociadoMensaje</em></div>
                    </div>
                }
                <div class="d-flex gap-2">
                    <button class="btn btn-danger" @onclick="ConfirmarEliminarAsync">Eliminar definitivamente</button>
                    <button class="btn btn-secondary" @onclick="CancelarEliminar">Cancelar</button>
                </div>
            }
        </div>
    </div>
}

@if (ciudades == null)
{
    <p><em>Cargando ciudades...</em></p>
}
else if (!ciudades.Any())
{
    <div class="alert alert-info">
        <strong>No hay ciudades registradas.</strong>
        <p class="mb-0 mt-2">Las ciudades son necesarias para registrar cuentahabientes y sucursales.</p>
    </div>
}
else
{
    <div class="mb-3">
        <strong>Total de ciudades:</strong> @ciudades.Count
    </div>

    <div class="row">
        @foreach (var ciudad in ciudades)
        {
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">@ciudad.Nombre</h5>
                        <p class="card-text text-muted">ID: @ciudad.IdCiudad</p>
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div>
                                <button class="btn btn-sm btn-primary me-2" @onclick="() => MostrarEditarCiudad(ciudad)">Editar</button>
                                <button class="btn btn-sm btn-outline-danger" @onclick="() => SolicitarEliminarCiudad(ciudad)">Eliminar</button>
                            </div>
                            <small class="text-muted">
                                <span class="bi bi-geo-alt"></span> Ciudad
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>

    @* Bloques de edición/confirmación movidos al card superior para evitar duplicación *@
}

@if (mensaje != null)
{
    <div class="alert @(esError ? "alert-danger" : "alert-success") alert-dismissible fade show" role="alert">
        @mensaje
        <button type="button" class="btn-close" @onclick="() => mensaje = null"></button>
    </div>
}

<div class="card mt-4 bg-light">
    <div class="card-body">
        <h6 class="card-title">Información</h6>
        <p class="card-text mb-0">
            Las ciudades son datos maestros utilizados en:
        </p>
        <ul class="mt-2 mb-0">
            <li>Registro de cuentahabientes (dirección del cliente)</li>
            <li>Ubicación de sucursales bancarias</li>
            <li>Filtros y reportes por zona geográfica</li>
        </ul>
    </div>
</div>

@code {
    private List<Ciudad>? ciudades;
    private CiudadCreate nuevaCiudad = new();
    private bool mostrarFormulario = false;
    private string? mensaje;
    private bool esError;

    // Edit
    private Ciudad? ciudadEnEdicion;
    private bool editarFormulario = false;

    // Delete
    private int? ciudadAEliminarId;
    private string? ciudadAEliminarNombre;
    private string? cuentahabienteAsociadoMensaje;
    private bool mostrarConfirmEliminar = false;

    protected override async Task OnInitializedAsync()
    {
        await CargarCiudades();
    }

    private async Task CargarCiudades()
    {
        ciudades = await CatalogoService.GetCiudadesAsync();
    }

    private void MostrarFormularioCrear()
    {
        mostrarFormulario = true;
        nuevaCiudad = new();
    }

    private void CancelarFormulario()
    {
        mostrarFormulario = false;
        nuevaCiudad = new();
    }

    private async Task CrearCiudad()
    {
        var resultado = await CatalogoService.CreateCiudadAsync(nuevaCiudad);
        if (resultado != null)
        {
            mensaje = $"Ciudad '{resultado.Nombre}' creada exitosamente";
            esError = false;
            mostrarFormulario = false;
            nuevaCiudad = new();
            await CargarCiudades();
        }
        else
        {
            mensaje = "Error al crear la ciudad. Verifique que no exista ya.";
            esError = true;
        }
    }

    // Mostrar edición inline
    private void MostrarEditarCiudad(Ciudad ciudad)
    {
        // crear copia para editar sin mutar la lista hasta guardar
        ciudadEnEdicion = new Ciudad { IdCiudad = ciudad.IdCiudad, Nombre = ciudad.Nombre };
        editarFormulario = true;
    }

    private void CancelarEdicion()
    {
        editarFormulario = false;
        ciudadEnEdicion = null;
    }

    private async Task GuardarEdicion()
    {
        if (ciudadEnEdicion == null)
            return;

        var updated = await CatalogoService.UpdateCiudadAsync(ciudadEnEdicion.IdCiudad, new CiudadCreate { Nombre = ciudadEnEdicion.Nombre });
        if (updated != null)
        {
            mensaje = $"Ciudad '{updated.Nombre}' actualizada correctamente.";
            esError = false;
            editarFormulario = false;
            ciudadEnEdicion = null;
            await CargarCiudades();
        }
        else
        {
            mensaje = "Error al actualizar la ciudad.";
            esError = true;
        }
    }

    // Solicitar eliminación mostrando la asociación con cuentahabientes
    private async Task SolicitarEliminarCiudad(Ciudad ciudad)
    {
        ciudadAEliminarId = ciudad.IdCiudad;
        ciudadAEliminarNombre = ciudad.Nombre;

        var chs = await CuentahabienteService.GetCuentahabientesAsync();
        var asociados = chs?.Where(x => x.IdCiudad == ciudad.IdCiudad).ToList();
        if (asociados != null && asociados.Any())
        {
            cuentahabienteAsociadoMensaje = string.Join(", ", asociados.Select(a => $"{a.Nombre} ({a.Documento})"));
        }
        else
        {
            cuentahabienteAsociadoMensaje = null;
        }

        mostrarConfirmEliminar = true;
    }

    private async Task ConfirmarEliminarAsync()
    {
        if (!ciudadAEliminarId.HasValue)
            return;

        var ok = await CatalogoService.DeleteCiudadAsync(ciudadAEliminarId.Value);
        if (ok)
        {
            mensaje = $"Ciudad '{ciudadAEliminarNombre}' eliminada correctamente.";
            esError = false;
            await CargarCiudades();
        }
        else
        {
            mensaje = "Error al eliminar la ciudad.";
            esError = true;
        }

        // limpiar estado
        mostrarConfirmEliminar = false;
        ciudadAEliminarId = null;
        ciudadAEliminarNombre = null;
        cuentahabienteAsociadoMensaje = null;
    }

    private void CancelarEliminar()
    {
        mostrarConfirmEliminar = false;
        ciudadAEliminarId = null;
        ciudadAEliminarNombre = null;
        cuentahabienteAsociadoMensaje = null;
    }
}